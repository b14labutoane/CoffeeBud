<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <style>
        body{
            padding:30px;
            background:linear-gradient(to right, #e2e2e2, #c9d6ff);
            justify-content: center;
            align-items: center; /* Center content horizontally */
            height: 100vh;
        }
        h1{
            text-align:center;
        }
        button{
            color:blueviolet;
            background-color:#c9d6ff;
            padding:5px;
            border-radius:5px;
            font-size:1rem;
            font-weight:bold;
            border:none;
        }
        button:hover{
            text-decoration: underline;
            color:blue;
        }
        button, div{
            margin-left:15%;
            font-size:20px;
            padding:10px;
        }
        div{
            font-weight:400;
            color:rgb(12,11,11);
        }
        span{
            font-weight:600;
            font-size:22px;
            color:black;
        }
        #imagePreview{
            margin-top: 20px;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ccc;
            margin-bottom: 20px;
        }
        #imageUploader{
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .file-upload-container {
            margin-top: 20px;
        }
        input[type="file"]{
            margin-bottom: 10px;
        }
        .upload-section {
            display: block; /* Initially visible */
        }
        .profile-section {
            display: none; /* Initially hidden */
        }
    </style>
    <script type="module" src="./homepage.js"></script>
</head>
<body>
    <h1>Welcome to the Homepage</h1>
    <!-- Profile section (only visible when logged in) -->
    <div class="profile-section" id="profileSection">
        <h2>Your Profile Picture</h2>
        <img id="imagePreview" src="" alt="Profile Picture">
    </div>
    <div>First Name: <span id="loggedUserFName"></span></div>
    <div>Last Name: <span id="loggedUserLName"></span></div>
    <div>Email: <span id="loggedUserEmail"></span></div>
    <button id="logout">Logout</button>

    <!-- Upload section (only visible when not logged in) -->
    <div id="imageUploader" class="upload-section">
        <h2>Upload Profile Picture</h2>
        <div class="file-upload-container">
            <input type="file" id="fileInput" accept="image/*">
            <button id="uploadImage">Upload Image</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAu2lp1BsnqTdc3FK9gATIMWevtkttGK68",
            authDomain: "coffeebud-d0960.firebaseapp.com",
            projectId: "coffeebud-d0960",
            storageBucket: "coffeebud-d0960.firebasestorage.app",
            messagingSenderId: "1061672167679",
            appId: "1:1061672167679:web:f39ecd079d344f6f0484ca",
            measurementId: "G-G7LZYRSW5G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Handle user authentication state change
        onAuthStateChanged(auth, async (user) => {
            const imageUploader = document.getElementById('imageUploader');
            const profileSection = document.getElementById('profileSection');

            if (user) {
                // User is signed in
                const userData = await getUserData(user.uid);
                document.getElementById('loggedUserFName').textContent = userData.firstName;
                document.getElementById('loggedUserLName').textContent = userData.lastName;
                document.getElementById('loggedUserEmail').textContent = user.email;

                // Hide the upload section and show the profile section
                imageUploader.style.display = 'none';
                profileSection.style.display = 'block';

                // Display the user's profile picture if available
                const imagePreview = document.getElementById("imagePreview");
                if (userData.profilePicURL) {
                    imagePreview.src = userData.profilePicURL;
                }
            } else {
                // User is not signed in
                console.log('User not signed in');
                imageUploader.style.display = 'block';
                profileSection.style.display = 'none';
            }
        });

        // Fetch user data from Firestore
        async function getUserData(userId) {
            const userRef = doc(db, 'users', userId); // Assuming you store user data in 'users' collection
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                return userDoc.data();
            } else {
                console.log("No such document!");
                return {};
            }
        }

        // Handle Image Upload
        async function uploadImage() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (file) {
                const storageRef = ref(storage, `uploaded_images/${file.name}`);
                await uploadBytes(storageRef, file);

                const imageURL = await getDownloadURL(storageRef);
                const imagePreview = document.getElementById("imagePreview");
                imagePreview.src = imageURL;

                // Get current user
                const user = auth.currentUser;
                if (user) {
                    // Update the user's profile picture URL in Firestore
                    await updateDoc(doc(db, 'users', user.uid), {
                        profilePicURL: imageURL
                    });
                }
            }
        }

        const uploadButton = document.getElementById("uploadImage");
        uploadButton.addEventListener('click', uploadImage);

        // Logout functionality
        const logoutButton = document.getElementById('logout');
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
            console.log('User signed out');
        });
    </script>
</body>
</html>
