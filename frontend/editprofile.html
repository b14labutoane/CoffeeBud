<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="editprofile.css">
    <script type="module" src="firebaseauth.js"></script>
    <script type="module" src="./homepage.js"></script>
</head>
<body>
    <div class="container">
        <div class="window">
            <div class="overlay"></div>
            <div class="content">
                <!-- Profile Section -->
                <div class="profile-section" id="profileSection">
                    <h2>Your CoffeeBud Profile</h2>
                    <img id="imagePreview" src="" alt="Profile Picture">
                </div>

                <!-- User Info Section -->
                <div class="input-fields">
                    <div>First Name: <span id="loggedUserFName"></span></div>
                    <div>Last Name: <span id="loggedUserLName"></span></div>
                    <div>Email: <span id="loggedUserEmail"></span></div>
                </div>

                <!-- Edit Button -->
                <div><button class="ghost-round full-width" id="editProfileButton">Edit Profile</button></div>

                <!-- Logout Button -->
                <button id="logout" class="ghost-round full-width">Logout</button>

                <!-- Image Upload Section -->
                <div id="imageUploader" class="upload-section" style="display: none;">
                    <h2>Upload Profile Picture</h2>
                    <div class="file-upload-container">
                        <input type="file" id="fileInput" accept="image/*">
                        <button id="uploadImage">Upload Image</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAu2lp1BsnqTdc3FK9gATIMWevtkttGK68",
            authDomain: "coffeebud-d0960.firebaseapp.com",
            projectId: "coffeebud-d0960",
            storageBucket: "coffeebud-d0960.firebasestorage.app",
            messagingSenderId: "1061672167679",
            appId: "1:1061672167679:web:f39ecd079d344f6f0484ca",
            measurementId: "G-G7LZYRSW5G"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // On Authentication State Changed
        onAuthStateChanged(auth, async (user) => {
            const imageUploader = document.getElementById('imageUploader');
            const profileSection = document.getElementById('profileSection');
            const uploadButton = document.getElementById('uploadImage');
            const imagePreview = document.getElementById("imagePreview");

            if (user) {
                // User is signed in
                const userData = await getUserData(user.uid);
                document.getElementById('loggedUserFName').textContent = userData.firstName;
                document.getElementById('loggedUserLName').textContent = userData.lastName;
                document.getElementById('loggedUserEmail').textContent = user.email;

                // If the user has a profile picture, show the profile section
                if (userData.profilePicURL) {
                    imagePreview.src = userData.profilePicURL;
                    imageUploader.style.display = 'none'; // Hide upload section
                    profileSection.style.display = 'block'; // Show profile section
                } else {
                    // If no profile picture, show the upload section
                    imageUploader.style.display = 'block'; // Show upload section
                    profileSection.style.display = 'none'; // Hide profile section
                }
            } else {
                // User is not signed in
                imageUploader.style.display = 'block'; // Show upload section
                profileSection.style.display = 'none'; // Hide profile section
            }
        });

        // Fetch user data from Firestore
        async function getUserData(userId) {
            const userRef = doc(db, 'users', userId);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                return userDoc.data();
            } else {
                return {};
            }
        }

        // Handle Image Upload
        async function uploadImage() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (file) {
                const storageRef = ref(storage, `uploaded_images/${file.name}`);
                await uploadBytes(storageRef, file);

                const imageURL = await getDownloadURL(storageRef);
                const imagePreview = document.getElementById("imagePreview");
                imagePreview.src = imageURL;

                const user = auth.currentUser;
                if (user) {
                    await updateDoc(doc(db, 'users', user.uid), {
                        profilePicURL: imageURL
                    });
                }

                // Switch back to profile section after upload
                profileSection.style.display = 'block';
                imageUploader.style.display = 'none';
            }
        }

        const uploadButton = document.getElementById("uploadImage");
        uploadButton.addEventListener('click', uploadImage);

        // Handle Edit Profile Button Click
        const editProfileButton = document.getElementById("editProfileButton");
        editProfileButton.addEventListener("click", () => {
            const imageUploader = document.getElementById("imageUploader");
            const profileSection = document.getElementById("profileSection");

            // Toggle between profile and image upload sections
            if (profileSection.style.display === "block") {
                profileSection.style.display = "none"; // Hide profile section
                imageUploader.style.display = "block"; // Show image upload section
            } else {
                profileSection.style.display = "block"; // Show profile section
                imageUploader.style.display = "none"; // Hide image upload section
            }
        });

        // Logout functionality
        const logoutButton = document.getElementById('logout');
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });
    </script>
</body>
</html>
